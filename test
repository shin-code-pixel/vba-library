Option Explicit

'========================================
' 実務用：テストケース表（帳票）を作成
' - 見やすい帳票（フォント/罫線/色/固定/フィルタ）
' - ListObject（テーブル）化
' - 入力規則（観点/判定）
' - 条件付き書式（OK/NG）
'========================================
Public Sub VBL_CreateTestCaseSheet_Run()
    VBL_CreateTestCaseSheet "TestCases"
End Sub

Public Sub VBL_CreateTestCaseSheet(Optional ByVal sheetName As String = "TestCases")
    Dim wb As Workbook: Set wb = ThisWorkbook
    Dim ws As Worksheet

    '--- 既存があれば作り直し
    If SheetExists(wb, sheetName) Then
        If MsgBox("シート '" & sheetName & "' は既に存在します。削除して作り直しますか？", vbYesNo + vbQuestion) <> vbYes Then Exit Sub
        Application.DisplayAlerts = False
        wb.Worksheets(sheetName).Delete
        Application.DisplayAlerts = True
    End If

    Set ws = wb.Worksheets.Add(After:=wb.Worksheets(wb.Worksheets.Count))
    ws.Name = sheetName

    '--- 帳票の基本設定（見た目）
    With ws.Cells
        .Font.Name = "Meiryo UI"
        .Font.Size = 10
    End With
    ws.Rows.RowHeight = 18

    '--- ヘッダ（実務用に必要最小限＋ID/優先度/実行日/担当）
    Dim headers As Variant
    headers = Array( _
        "TC_ID", _
        "対象", _
        "観点", _
        "優先度(P1/P2/P3)", _
        "前提条件", _
        "入力", _
        "操作", _
        "期待結果", _
        "実結果", _
        "判定(OK/NG)", _
        "実行日", _
        "担当", _
        "証跡(ログ/スクショ/ファイル)", _
        "備考" _
    )

    Dim lastCol As Long: lastCol = UBound(headers) + 1

    Dim c As Long
    For c = 1 To lastCol
        ws.Cells(1, c).Value = headers(c - 1)
    Next

    '--- テーブル化（フィルタ・帯色・並べ替え前提）
    Dim lo As ListObject
    Set lo = ws.ListObjects.Add(xlSrcRange, ws.Range(ws.Cells(1, 1), ws.Cells(2, lastCol)), , xlYes)
    lo.Name = "tbl_TestCases"
    lo.TableStyle = "TableStyleMedium9"

    '--- ヘッダ行の見た目（帳票感）
    With ws.Range(ws.Cells(1, 1), ws.Cells(1, lastCol))
        .Font.Bold = True
        .WrapText = True
        .VerticalAlignment = xlVAlignCenter
        .RowHeight = 30
    End With

    '--- 列幅（見やすさ優先：後で微調整しやすい値）
    ws.Columns(1).ColumnWidth = 10  ' TC_ID
    ws.Columns(2).ColumnWidth = 18  ' 対象
    ws.Columns(3).ColumnWidth = 10  ' 観点
    ws.Columns(4).ColumnWidth = 12  ' 優先度
    ws.Columns(5).ColumnWidth = 18  ' 前提
    ws.Columns(6).ColumnWidth = 18  ' 入力
    ws.Columns(7).ColumnWidth = 18  ' 操作
    ws.Columns(8).ColumnWidth = 24  ' 期待
    ws.Columns(9).ColumnWidth = 24  ' 実結果
    ws.Columns(10).ColumnWidth = 10 ' 判定
    ws.Columns(11).ColumnWidth = 12 ' 実行日
    ws.Columns(12).ColumnWidth = 12 ' 担当
    ws.Columns(13).ColumnWidth = 22 ' 証跡
    ws.Columns(14).ColumnWidth = 18 ' 備考

    '--- 入力セルを「入力しやすく」する（折り返し）
    With lo.DataBodyRange
        .WrapText = True
        .VerticalAlignment = xlVAlignTop
    End With

    '--- 固定（ヘッダ行）
    ws.Activate
    ws.Range("A2").Select
    ActiveWindow.FreezePanes = True

    '--- 入力規則（観点/判定/優先度）
    ApplyListValidation lo.ListColumns("観点").DataBodyRange, "VAL,BND,FMT,IO,FLOW,ERR,CON,PERF,CFG"
    ApplyListValidation lo.ListColumns("判定(OK/NG)").DataBodyRange, "OK,NG"
    ApplyListValidation lo.ListColumns("優先度(P1/P2/P3)").DataBodyRange, "P1,P2,P3"

    '--- 実行日は日付入力に（任意）
    ApplyDateValidation lo.ListColumns("実行日").DataBodyRange

    '--- 罫線（帳票）
    With ws.Range(ws.Cells(1, 1), ws.Cells(200, lastCol)).Borders
        .LineStyle = xlContinuous
        .Color = RGB(200, 200, 200)
    End With

    '--- 条件付き書式：判定 OK/NG を強調
    ApplyJudgeConditionalFormat lo.ListColumns("判定(OK/NG)").DataBodyRange

    '--- 入力ガイド行（2行目）を少しだけ用意（邪魔なら消してOK）
    ws.Cells(2, 3).Value = "例: VAL"
    ws.Cells(2, 4).Value = "例: P1"
    ws.Cells(2, 10).Value = "例: OK"
    ws.Cells(2, 11).Value = Date

    ws.Range("A1").Select
End Sub

'========================
' 内部
'========================
Private Function SheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    On Error Resume Next
    SheetExists = Not wb.Worksheets(sheetName) Is Nothing
    On Error GoTo 0
End Function

Private Sub ApplyListValidation(ByVal target As Range, ByVal csv As String)
    If target Is Nothing Then Exit Sub
    On Error Resume Next
    target.Validation.Delete
    On Error GoTo 0
    target.Validation.Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:=csv
    target.Validation.InCellDropdown = True
    target.Validation.IgnoreBlank = True
End Sub

Private Sub ApplyDateValidation(ByVal target As Range)
    If target Is Nothing Then Exit Sub
    On Error Resume Next
    target.Validation.Delete
    On Error GoTo 0
    target.Validation.Add Type:=xlValidateDate, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, _
                          Formula1:="DATE(2000,1,1)", Formula2:="DATE(2099,12,31)"
    target.NumberFormatLocal = "yyyy/mm/dd"
End Sub

Private Sub ApplyJudgeConditionalFormat(ByVal target As Range)
    If target Is Nothing Then Exit Sub

    target.FormatConditions.Delete

    ' OK
    With target.FormatConditions.Add(Type:=xlCellValue, Operator:=xlEqual, Formula1:="=""OK""")
        .Font.Bold = True
        .Interior.Color = RGB(220, 255, 220)
    End With

    ' NG
    With target.FormatConditions.Add(Type:=xlCellValue, Operator:=xlEqual, Formula1:="=""NG""")
        .Font.Bold = True
        .Interior.Color = RGB(255, 220, 220)
    End With
End Sub    
    ' 列幅（最小限）
    ws.Columns(1).ColumnWidth = 12   ' TC_ID
    ws.Columns(2).ColumnWidth = 28   ' 対象
    ws.Columns(3).ColumnWidth = 18   ' 観点
    ws.Columns(4).ColumnWidth = 22   ' 前提
    ws.Columns(5).ColumnWidth = 18   ' 入力
    ws.Columns(6).ColumnWidth = 18   ' 操作
    ws.Columns(7).ColumnWidth = 26   ' 期待
    ws.Columns(8).ColumnWidth = 26   ' 実結果
    ws.Columns(9).ColumnWidth = 12   ' 判定
    ws.Columns(10).ColumnWidth = 22  ' 証跡
    ws.Columns(11).ColumnWidth = 22  ' 備考
    
    ' 行高
    ws.Rows(1).RowHeight = 36
    
    ' ウィンドウ固定（ヘッダ行）
    ws.Activate
    ws.Range("A2").Select
    ActiveWindow.FreezePanes = True
    
    ' 入力規則：観点（VAL/BND/FMT/IO/FLOW/ERR/CON/PERF/CFG）
    ApplyListValidation ws, tbl.ListColumns(3).DataBodyRange, _
        "VAL,BND,FMT,IO,FLOW,ERR,CON,PERF,CFG"
    
    ' 入力規則：判定（OK/NG）
    ApplyListValidation ws, tbl.ListColumns(9).DataBodyRange, _
        "OK,NG"
    
    ' 2行目は空欄のまま（テーブル維持のため）
    ws.Cells(2, 1).Value = ""
    
    ' 罫線（見やすさ）
    With ws.Range(ws.Cells(1, 1), ws.Cells(200, UBound(headers) + 1))
        .Borders.LineStyle = xlContinuous
        .Borders.Color = RGB(210, 210, 210)
    End With
    
    ws.Range("A1").Select
End Sub

'----------------------------------------
' 内部：シート存在チェック
'----------------------------------------
Private Function SheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    On Error Resume Next
    SheetExists = Not wb.Worksheets(sheetName) Is Nothing
    On Error GoTo 0
End Function

'----------------------------------------
' 内部：リスト入力規則（ドロップダウン）設定
'----------------------------------------
Private Sub ApplyListValidation(ByVal ws As Worksheet, ByVal target As Range, ByVal csv As String)
    If target Is Nothing Then Exit Sub
    
    ' 既存の入力規則を削除
    On Error Resume Next
    target.Validation.Delete
    On Error GoTo 0
    
    target.Validation.Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, _
                          Operator:=xlBetween, Formula1:=csv
    target.Validation.InCellDropdown = True
    target.Validation.IgnoreBlank = True
    target.Validation.ShowError = True
End Sub    SheetExists = Not wb.Worksheets(sheetName) Is Nothing
    On Error GoTo 0
End Function
