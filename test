Option Explicit

' =========================
' Assert (断言) ユーティリティ
' =========================

Public Sub AssertTrue(ByVal condition As Boolean, Optional ByVal message As String = "")
'    If Not condition Then
'        Err.Raise vbObjectError + 1000, "AssertTrue", NzMsg(message, "Expected True, but was False.")
'    End If
End Sub

Public Sub AssertFalse(ByVal condition As Boolean, Optional ByVal message As String = "")
    If condition Then
        Err.Raise vbObjectError + 1001, "AssertFalse", NzMsg(message, "Expected False, but was True.")
    End If
End Sub

Public Sub AssertEquals(ByVal expected As Variant, ByVal actual As Variant, Optional ByVal message As String = "")
    If Not VariantEquals(expected, actual) Then
        Err.Raise vbObjectError + 1002, "AssertEquals", _
            NzMsg(message, "Not equal. expected=[" & ToDebugText(expected) & "] actual=[" & ToDebugText(actual) & "]")
    End If
End Sub

Public Sub AssertNotEquals(ByVal notExpected As Variant, ByVal actual As Variant, Optional ByVal message As String = "")
    If VariantEquals(notExpected, actual) Then
        Err.Raise vbObjectError + 1003, "AssertNotEquals", _
            NzMsg(message, "Should not equal. value=[" & ToDebugText(actual) & "]")
    End If
End Sub

Public Sub AssertNotNothing(ByVal obj As Object, Optional ByVal message As String = "")
    If obj Is Nothing Then
        Err.Raise vbObjectError + 1004, "AssertNotNothing", NzMsg(message, "Object is Nothing.")
    End If
End Sub

Public Sub AssertContains(ByVal haystack As String, ByVal needle As String, Optional ByVal message As String = "")
    If InStr(1, haystack, needle, vbBinaryCompare) = 0 Then
        Err.Raise vbObjectError + 1005, "AssertContains", _
            NzMsg(message, "Not contains. needle=[" & needle & "] haystack=[" & haystack & "]")
    End If
End Sub

' 例外（エラー）を期待するテスト用
'「このプロシージャを実行したら、このエラー番号が出るはす」ということを検証するための関数
'「この処理は失敗して当然」をテストとして成立させるための仕組み
'Public Sub AssertRaises(ByVal expectedErrNumber As Long, ByVal procName As String, Optional ByVal message As String = "")
'    Dim fullName As String
'    fullName = "'" & ThisWorkbook.name & "'!" & procName
'
'    On Error GoTo EH
'    Application.Run fullName
'
'    'エラーが出なかったら失敗
'    Err.Raise vbObjectError + 1006, "AssertRaises", NzMsg(message, _
'                                                    "Expected error " & expectedErrNumber & ", but no error was raised.")
'    Exit Sub
'
'EH:
'    Debug.Print "AssertRaises got Err.Number=", Err.Number
'
'    '期待したエラーなら　PASS（ここで必ず終わる）
'    If Err.Number = expectedErrNumber Then
'        Err.Clear
'        Exit Sub
'    End If
'
'    '違うエラーなら FAIL
'    Dim gotNum As Long: gotNum = Err.Number
'    Dim gotDesc As String: gotDesc = Err.Description
'    Err.Clear
'    Err.Raise vbObjectError + 1007, "AssertRaises", NzMsg(message, _
'        "Expected error " & expectedErrNumber & ", but got " & gotNum & IIf(Len(gotDesc) > 0, " : " & gotDesc, ""))
'End Sub

' -------------------------
' 内部ユーティリティ
' -------------------------

Private Function VariantEquals(ByVal a As Variant, ByVal b As Variant) As Boolean
    ' Null/Empty 対応
    If IsNull(a) And IsNull(b) Then VariantEquals = True: Exit Function
    If IsEmpty(a) And IsEmpty(b) Then VariantEquals = True: Exit Function

    ' 型が違っても比較できる範囲は吸収（実務優先）
    If IsDate(a) And IsDate(b) Then
        VariantEquals = (CDbl(CDate(a)) = CDbl(CDate(b)))
        Exit Function
    End If

    If IsNumeric(a) And IsNumeric(b) Then
        ' Double誤差を避けたい場合は別途 AssertAlmostEquals を追加してください
        VariantEquals = (CDbl(a) = CDbl(b))
        Exit Function
    End If

    VariantEquals = (CStr(a) = CStr(b))
End Function

Private Function ToDebugText(ByVal v As Variant) As String
    If IsNull(v) Then
        ToDebugText = "<Null>"
    ElseIf IsEmpty(v) Then
        ToDebugText = "<Empty>"
    Else
        ToDebugText = CStr(v)
    End If
End Function

Private Function NzMsg(ByVal msg As String, ByVal fallback As String) As String
    If Len(Trim$(msg)) = 0 Then
        NzMsg = fallback
    Else
        NzMsg = msg
    End If
End Function

